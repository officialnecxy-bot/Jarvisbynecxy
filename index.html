<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S - ULTIMATE API FIX</title>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;500;700&family=Rajdhani:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff2a2a; 
            --dark: #000000;
            --glass: rgba(255, 42, 42, 0.08); 
            --text: #ffffff;
            --border: rgba(255, 42, 42, 0.4);
            --glow: 0 0 15px var(--primary);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            background-color: var(--dark);
            color: var(--text);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-image: radial-gradient(circle at 50% 50%, #1a0000 0%, #000000 80%);
            overflow: hidden;
        }

        /* --- CORE STYLES (Retained) --- */
        .core-container {
            position: relative; width: 250px; height: 250px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.3s; margin-bottom: 30px;
        }
        .core-container:active { transform: scale(0.95); }
        .arc-ring { position: absolute; border-radius: 50%; border: 2px solid var(--border); }
        .r1 { width: 100%; height: 100%; border: 3px dashed var(--border); animation: spin-left 15s linear infinite; }
        .r2 { width: 80%; height: 80%; border-top: 5px solid var(--primary); border-bottom: 5px solid var(--primary); animation: spin-right 8s linear infinite; }
        .r3 { width: 60%; height: 60%; background: var(--dark); box-shadow: 0 0 50px var(--primary); }
        .core-center { width: 80px; height: 80px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 40px var(--primary); transition: 0.3s; }
        .core-container.active .core-center { background: white; animation: pulse 1s infinite alternate; }
        .core-container.active .arc-ring { border-color: white; }

        @keyframes spin-right { 100% { transform: rotate(360deg); } }
        @keyframes spin-left { 100% { transform: rotate(-360deg); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.9; } 100% { transform: scale(1.2); opacity: 1; } }

        /* --- CONSOLE LOG --- */
        .console {
            width: 90%; max-width: 550px; height: 150px;
            background: var(--glass); backdrop-filter: blur(5px);
            border: 1px solid var(--border); border-radius: 10px;
            padding: 15px; overflow-y: auto; font-family: 'Share Tech Mono', monospace;
            font-size: 0.9rem; box-shadow: 0 0 10px rgba(255, 42, 42, 0.1);
            position: absolute; bottom: 20px;
        }

        .log-line { line-height: 1.4; margin-bottom: 5px; }
        .log-line.user { color: var(--primary); }
        .log-line.jarvis { color: var(--text); }
        
        /* --- STATUS DISPLAY --- */
        .status-display {
            font-family: 'Teko', sans-serif; font-size: 2.5rem; letter-spacing: 5px;
            text-shadow: 0 0 10px var(--primary);
        }
    </style>
</head>
<body>

    <div class="status-display" id="status">सिस्टम बूटिंग...</div>

    <div class="core-container" id="mic-btn" onclick="jarvis.toggle()">
        <div class="arc-ring r1"></div>
        <div class="arc-ring r2"></div>
        <div class="arc-ring r3"></div>
        <div class="core-center"></div>
    </div>

    <div class="console" id="log-screen">
        <div class="log-line jarvis">Jarvis Console: API कनेक्टिविटी और वॉइस मॉड्यूल की जाँच हो रही है।</div>
    </div>

<script>
    // --- API KEY (Fixed) ---
    const API_KEY = "AIzaSyAzINqsAHdMMLiXpLCwet0O540MB5xX5qg"; 
    const MODEL_NAME = "gemini-1.5-flash"; // UPGRADED MODEL

    const jarvis = {
        recognition: null,
        isListening: false,
        
        init: () => {
            if ('webkitSpeechRecognition' in window) {
                jarvis.recognition = new webkitSpeechRecognition();
                jarvis.recognition.continuous = false;
                jarvis.recognition.lang = 'hi-IN'; 
                jarvis.recognition.interimResults = false;

                jarvis.recognition.onstart = () => {
                    jarvis.isListening = true;
                    jarvis.updateUI("सुन रहा हूँ...", true);
                };

                jarvis.recognition.onend = () => {
                    jarvis.isListening = false;
                    if(!window.speechSynthesis.speaking) jarvis.updateUI("तैयार हूँ", false);
                };

                jarvis.recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    jarvis.logCommand(text);
                    jarvis.updateUI("सोच रहा हूँ...", true);
                    jarvis.processCommand(text);
                };
            } else {
                jarvis.logResponse("Error: यह ब्राउज़र वॉयस सपोर्ट नहीं करता। कृपया Chrome का उपयोग करें।");
                jarvis.updateUI("त्रुटि", false);
            }
            // Pre-load voices for quick speak
            window.speechSynthesis.getVoices();
            jarvis.speak("नमस्कार सर, मैं जार्विस हूँ। अब एपीआई एकदम स्थिर है।");
        },

        toggle: () => {
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                jarvis.updateUI("रोका गया", false);
                return;
            }
            if (jarvis.isListening) jarvis.recognition.stop();
            else try { jarvis.recognition.start(); } catch(e) {}
        },

        updateUI: (status, active) => {
            document.getElementById('status').innerText = status;
            const btn = document.getElementById('mic-btn');
            if(active) btn.classList.add('active');
            else btn.classList.remove('active');
        },
        
        logCommand: (cmd) => {
            const logScreen = document.getElementById('log-screen');
            logScreen.innerHTML += `<div class="log-line user">आप: ${cmd}</div>`;
            logScreen.scrollTop = logScreen.scrollHeight;
        },
        
        logResponse: (text) => {
            const logScreen = document.getElementById('log-screen');
            logScreen.innerHTML += `<div class="log-line jarvis">Jarvis: ${text}</div>`;
            logScreen.scrollTop = logScreen.scrollHeight;
        },

        speak: (text) => {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'hi-IN';
            
            const voices = window.speechSynthesis.getVoices();
            let maleHindiVoice = voices.find(v => v.lang.startsWith('hi') && (v.name.includes('Male') || v.name.includes('Google') || v.name.includes('Hindi')));
            
            if (!maleHindiVoice) maleHindiVoice = voices.find(v => v.lang.startsWith('hi'));
            if(maleHindiVoice) utterance.voice = maleHindiVoice;
            
            utterance.rate = 0.9; 
            utterance.pitch = 0.85;

            jarvis.updateUI("बोल रहा हूँ...", true);
            
            utterance.onend = () => jarvis.updateUI("तैयार हूँ", false);
            window.speechSynthesis.speak(utterance);
            jarvis.logResponse(text);
        },

        processCommand: async (cmd) => {
            const command = cmd.toLowerCase();

            // Local Commands (Fast Response)
            if (command.includes("समय बताओ") || command.includes("time kya hai")) {
                const time = new Date().toLocaleTimeString('hi-IN', { hour: 'numeric', minute: 'numeric', hour12: true });
                jarvis.speak(`अभी ${time} हुआ है सर।`);
            } 
            else if (command.includes("गूगल खोलो") || command.includes("google search")) {
                jarvis.speak("आपके लिए गूगल खोल रहा हूँ सर।");
                window.open("https://google.com", "_blank");
            }
            else {
                // Send to Gemini AI for Stable Response
                await jarvis.askGemini(cmd);
            }
        },

        askGemini: async (prompt) => {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [{ 
                                text: `You are JARVIS. Reply only in short HINDI language (max 2 sentences). User asks: ${prompt}`
                            }] 
                        }]
                    })
                });

                const data = await response.json();
                
                // Check for API/Request Errors first
                if (data.error) {
                    jarvis.speak("माफ़ कीजिये सर, एपीआई सर्वर पर बड़ी त्रुटि आई है। कृपया कुंजी (Key) की जाँच करें।");
                    return;
                }
                
                // Check if candidate exists
                if (data.candidates && data.candidates.length > 0) {
                    const reply = data.candidates[0].content.parts[0].text;
                    const cleanReply = reply.replace(/[*#`]/g, '');
                    jarvis.speak(cleanReply);
                } else {
                    jarvis.speak("माफ़ कीजिये सर, मैं आपके सवाल का जवाब नहीं दे पाया।");
                }

            } catch (error) {
                jarvis.speak("सर, नेटवर्क या एपीआई में कोई गंभीर समस्या है।");
                jarvis.updateUI("नेटवर्क एरर", false);
            }
        }
    };

    window.onload = jarvis.init;
</script>
</body>
</html>
